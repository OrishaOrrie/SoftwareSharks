{"version":3,"sources":["../../../src/plugins/ThumbnailGenerator/index.test.js"],"names":["ThumbnailGeneratorPlugin","require","Plugin","delay","setTimeout","resolve","duration","describe","it","plugin","expect","toEqual","plugin1","opts","thumbnailWidth","plugin2","core","on","jest","fn","addToQueue","install","toHaveBeenCalledTimes","toHaveBeenCalledWith","off","uninstall","processQueue","file","foo","queueProcessing","queue","file2","requestThumbnail","file1","file3","then","createThumbnail","mockReturnValue","setPreviewURL","id","type","isRemote","state","files","preview","setState","getProportionalHeight","width","height","canvas","toBlob","canvasToBlob","mock","calls","originalDocumentCreateElement","originalURLCreateObjectURL","beforeEach","document","createElement","URL","createObjectURL","afterEach","xit","image","context","drawImage","getContext","result","downScaleInSteps","newImage","sourceWidth","sourceHeight","resizeImage"],"mappings":"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","file":"index.test.js","sourcesContent":["const ThumbnailGeneratorPlugin = require('./index')\nconst Plugin = require('../../core/Plugin')\n\nconst delay = duration => new Promise(resolve => setTimeout(resolve, duration))\n\ndescribe('uploader/ThumbnailGeneratorPlugin', () => {\n  it('should initialise successfully', () => {\n    const plugin = new ThumbnailGeneratorPlugin(null, {})\n    expect(plugin instanceof Plugin).toEqual(true)\n  })\n\n  it('should accept the thumbnailWidth option and override the default', () => {\n    const plugin1 = new ThumbnailGeneratorPlugin(null) // eslint-disable-line no-new\n    expect(plugin1.opts.thumbnailWidth).toEqual(200)\n\n    const plugin2 = new ThumbnailGeneratorPlugin(null, { thumbnailWidth: 100 }) // eslint-disable-line no-new\n    expect(plugin2.opts.thumbnailWidth).toEqual(100)\n  })\n\n  describe('install', () => {\n    it('should subscribe to uppy file-added event', () => {\n      const core = {\n        on: jest.fn()\n      }\n\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      plugin.addToQueue = jest.fn()\n      plugin.install()\n\n      expect(core.on).toHaveBeenCalledTimes(1)\n      expect(core.on).toHaveBeenCalledWith('file-added', plugin.addToQueue)\n    })\n  })\n\n  describe('uninstall', () => {\n    it('should unsubscribe from uppy file-added event', () => {\n      const core = {\n        on: jest.fn(),\n        off: jest.fn()\n      }\n\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      plugin.addToQueue = jest.fn()\n      plugin.install()\n\n      expect(core.on).toHaveBeenCalledTimes(1)\n\n      plugin.uninstall()\n\n      expect(core.off).toHaveBeenCalledTimes(1)\n      expect(core.off).toHaveBeenCalledWith('file-added', plugin.addToQueue)\n    })\n  })\n\n  describe('queue', () => {\n    it('should add a new file to the queue and start processing the queue when queueProcessing is false', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      plugin.processQueue = jest.fn()\n\n      const file = { foo: 'bar' }\n      plugin.queueProcessing = false\n      plugin.addToQueue(file)\n      expect(plugin.queue).toEqual([{ foo: 'bar' }])\n      expect(plugin.processQueue).toHaveBeenCalledTimes(1)\n\n      const file2 = { foo: 'bar2' }\n      plugin.queueProcessing = true\n      plugin.addToQueue(file2)\n      expect(plugin.queue).toEqual([{ foo: 'bar' }, { foo: 'bar2' }])\n      expect(plugin.processQueue).toHaveBeenCalledTimes(1)\n    })\n\n    it('should process items in the queue one by one', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n\n      plugin.requestThumbnail = jest.fn(() => delay(100))\n\n      const file1 = { foo: 'bar' }\n      const file2 = { foo: 'bar2' }\n      const file3 = { foo: 'bar3' }\n      plugin.addToQueue(file1)\n      plugin.addToQueue(file2)\n      plugin.addToQueue(file3)\n\n      expect(plugin.requestThumbnail).toHaveBeenCalledTimes(1)\n      expect(plugin.requestThumbnail).toHaveBeenCalledWith(file1)\n\n      return delay(110)\n        .then(() => {\n          expect(plugin.requestThumbnail).toHaveBeenCalledTimes(2)\n          expect(plugin.requestThumbnail).toHaveBeenCalledWith(file2)\n          return delay(110)\n        })\n        .then(() => {\n          expect(plugin.requestThumbnail).toHaveBeenCalledTimes(3)\n          expect(plugin.requestThumbnail).toHaveBeenCalledWith(file3)\n          return delay(110)\n        })\n        .then(() => {\n          expect(plugin.queue).toEqual([])\n          expect(plugin.queueProcessing).toEqual(false)\n        })\n    })\n  })\n\n  describe('requestThumbnail', () => {\n    it('should call createThumbnail if it is a supported filetype', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n\n      plugin.createThumbnail = jest\n        .fn()\n        .mockReturnValue(Promise.resolve('preview'))\n      plugin.setPreviewURL = jest.fn()\n\n      const file = { id: 'file1', type: 'image/png', isRemote: false }\n      return plugin.requestThumbnail(file).then(() => {\n        expect(plugin.createThumbnail).toHaveBeenCalledTimes(1)\n        expect(plugin.createThumbnail).toHaveBeenCalledWith(\n          file,\n          plugin.opts.thumbnailWidth\n        )\n      })\n    })\n\n    it('should not call createThumbnail if it is not a supported filetype', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n\n      plugin.createThumbnail = jest\n        .fn()\n        .mockReturnValue(Promise.resolve('preview'))\n      plugin.setPreviewURL = jest.fn()\n\n      const file = { id: 'file1', type: 'text/html', isRemote: false }\n      return plugin.requestThumbnail(file).then(() => {\n        expect(plugin.createThumbnail).toHaveBeenCalledTimes(0)\n      })\n    })\n\n    it('should not call createThumbnail if the file is remote', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n\n      plugin.createThumbnail = jest\n        .fn()\n        .mockReturnValue(Promise.resolve('preview'))\n      plugin.setPreviewURL = jest.fn()\n\n      const file = { id: 'file1', type: 'image/png', isRemote: true }\n      return plugin.requestThumbnail(file).then(() => {\n        expect(plugin.createThumbnail).toHaveBeenCalledTimes(0)\n      })\n    })\n\n    it('should call setPreviewURL with the thumbnail image', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n\n      plugin.createThumbnail = jest\n        .fn()\n        .mockReturnValue(Promise.resolve('preview'))\n      plugin.setPreviewURL = jest.fn()\n\n      const file = { id: 'file1', type: 'image/png', isRemote: false }\n      return plugin.requestThumbnail(file).then(() => {\n        expect(plugin.setPreviewURL).toHaveBeenCalledTimes(1)\n        expect(plugin.setPreviewURL).toHaveBeenCalledWith('file1', 'preview')\n      })\n    })\n  })\n\n  describe('setPreviewURL', () => {\n    it('should update the preview url for the specified image', () => {\n      const core = {\n        state: {\n          files: {\n            file1: {\n              preview: 'foo'\n            },\n            file2: {\n              preview: 'boo'\n            }\n          }\n        },\n        setState: jest.fn()\n      }\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      plugin.setPreviewURL('file1', 'moo')\n      expect(core.setState).toHaveBeenCalledTimes(1)\n      expect(core.setState).toHaveBeenCalledWith({\n        files: { file1: { preview: 'moo' }, file2: { preview: 'boo' } }\n      })\n    })\n  })\n\n  describe('getProportionalHeight', () => {\n    it('should calculate the resized height based on the specified width of the image whilst keeping aspect ratio', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      expect(\n        plugin.getProportionalHeight({ width: 200, height: 100 }, 50)\n      ).toEqual(25)\n      expect(\n        plugin.getProportionalHeight({ width: 66, height: 66 }, 33)\n      ).toEqual(33)\n      expect(\n        plugin.getProportionalHeight({ width: 201.2, height: 198.2 }, 47)\n      ).toEqual(46)\n    })\n  })\n\n  describe('canvasToBlob', () => {\n    it('should use canvas.toBlob if available', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      const canvas = {\n        toBlob: jest.fn()\n      }\n      plugin.canvasToBlob(canvas, 'type', 90)\n      expect(canvas.toBlob).toHaveBeenCalledTimes(1)\n      expect(canvas.toBlob.mock.calls[0][1]).toEqual('type')\n      expect(canvas.toBlob.mock.calls[0][2]).toEqual(90)\n    })\n  })\n\n  describe('downScaleInSteps', () => {\n    let originalDocumentCreateElement\n    let originalURLCreateObjectURL\n\n    beforeEach(() => {\n      originalDocumentCreateElement = document.createElement\n      originalURLCreateObjectURL = URL.createObjectURL\n    })\n\n    afterEach(() => {\n      document.createElement = originalDocumentCreateElement\n      URL.createObjectURL = originalURLCreateObjectURL\n    })\n\n    xit('should scale down the image by the specified number of steps', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      const image = {\n        width: 1000,\n        height: 800\n      }\n      const context = {\n        drawImage: jest.fn()\n      }\n      const canvas = {\n        width: 0,\n        height: 0,\n        getContext: jest.fn().mockReturnValue(context)\n      }\n      document.createElement = jest.fn().mockReturnValue(canvas)\n      const result = plugin.downScaleInSteps(image, 3)\n      const newImage = {\n        getContext: canvas.getContext,\n        height: 100,\n        width: 125\n      }\n      expect(result).toEqual({\n        image: newImage,\n        sourceWidth: 125,\n        sourceHeight: 100\n      })\n      expect(context.drawImage).toHaveBeenCalledTimes(3)\n      expect(context.drawImage.mock.calls).toEqual([\n        [{ width: 1000, height: 800 }, 0, 0, 1000, 800, 0, 0, 500, 400],\n        [\n          { width: 125, height: 100, getContext: canvas.getContext },\n          0,\n          0,\n          500,\n          400,\n          0,\n          0,\n          250,\n          200\n        ],\n        [\n          { width: 125, height: 100, getContext: canvas.getContext },\n          0,\n          0,\n          250,\n          200,\n          0,\n          0,\n          125,\n          100\n        ]\n      ])\n    })\n  })\n\n  describe('resizeImage', () => {\n    it('should return a canvas with the resized image on it', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      const image = {\n        width: 1000,\n        height: 800\n      }\n      const context = {\n        drawImage: jest.fn()\n      }\n      const canvas = {\n        width: 0,\n        height: 0,\n        getContext: jest.fn().mockReturnValue(context)\n      }\n      document.createElement = jest.fn().mockReturnValue(canvas)\n\n      const result = plugin.resizeImage(image, 200, 160)\n      expect(result).toEqual({\n        width: 200,\n        height: 160,\n        getContext: canvas.getContext\n      })\n    })\n\n    it('should upsize if original image is smaller than target size', () => {\n      const core = {}\n      const plugin = new ThumbnailGeneratorPlugin(core)\n      const image = {\n        width: 100,\n        height: 80\n      }\n      const context = {\n        drawImage: jest.fn()\n      }\n      const canvas = {\n        width: 0,\n        height: 0,\n        getContext: jest.fn().mockReturnValue(context)\n      }\n      document.createElement = jest.fn().mockReturnValue(canvas)\n\n      const result = plugin.resizeImage(image, 200, 160)\n      expect(result).toEqual({\n        width: 200,\n        height: 160,\n        getContext: canvas.getContext\n      })\n    })\n  })\n})\n"]}
{"version":3,"sources":["../../../src/plugins/ThumbnailGenerator/index.js"],"names":["Plugin","require","Utils","module","exports","uppy","opts","type","id","title","queue","queueProcessing","defaultOptions","thumbnailWidth","addToQueue","bind","createThumbnail","file","targetWidth","originalUrl","URL","createObjectURL","data","onload","resolve","reject","image","Image","src","revokeObjectURL","onerror","Error","then","targetHeight","getProportionalHeight","canvas","resizeImage","canvasToBlob","blob","protect","ratio","width","height","maxSquare","maxSize","maxW","Math","floor","sqrt","maxH","round","document","createElement","getContext","drawImage","steps","ceil","log2","sW","pow","sH","x","quality","toBlob","dataURItoBlob","toDataURL","img","aspect","setPreviewURL","fileID","preview","files","state","setState","item","push","processQueue","length","current","shift","requestThumbnail","catch","isPreviewSupported","isRemote","console","warn","err","stack","message","install","on","uninstall","off"],"mappings":"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","file":"index.js","sourcesContent":["const Plugin = require('../../core/Plugin')\nconst Utils = require('../../core/Utils')\n/**\n * The Thumbnail Generator plugin\n *\n */\n\nmodule.exports = class ThumbnailGenerator extends Plugin {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'thumbnail'\n    this.id = 'ThumbnailGenerator'\n    this.title = 'Thumbnail Generator'\n    this.queue = []\n    this.queueProcessing = false\n\n    const defaultOptions = {\n      thumbnailWidth: 200\n    }\n\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    this.addToQueue = this.addToQueue.bind(this)\n  }\n\n  /**\n   * Create a thumbnail for the given Uppy file object.\n   *\n   * @param {{data: Blob}} file\n   * @param {number} width\n   * @return {Promise}\n   */\n  createThumbnail (file, targetWidth) {\n    const originalUrl = URL.createObjectURL(file.data)\n    const onload = new Promise((resolve, reject) => {\n      const image = new Image()\n      image.src = originalUrl\n      image.onload = () => {\n        URL.revokeObjectURL(originalUrl)\n        resolve(image)\n      }\n      image.onerror = () => {\n        // The onerror event is totally useless unfortunately, as far as I know\n        URL.revokeObjectURL(originalUrl)\n        reject(new Error('Could not create thumbnail'))\n      }\n    })\n\n    return onload\n      .then(image => {\n        const targetHeight = this.getProportionalHeight(image, targetWidth)\n        const canvas = this.resizeImage(image, targetWidth, targetHeight)\n        return this.canvasToBlob(canvas, 'image/png')\n      })\n      .then(blob => {\n        return URL.createObjectURL(blob)\n      })\n  }\n\n  /**\n   * Make sure the image doesnâ€™t exceed browser/device canvas limits.\n   * For ios with 256 RAM and ie\n   */\n  protect (image) {\n    // https://stackoverflow.com/questions/6081483/maximum-size-of-a-canvas-element\n\n    var ratio = image.width / image.height\n\n    var maxSquare = 5000000  // ios max canvas square\n    var maxSize = 4096  // ie max canvas dimensions\n\n    var maxW = Math.floor(Math.sqrt(maxSquare * ratio))\n    var maxH = Math.floor(maxSquare / Math.sqrt(maxSquare * ratio))\n    if (maxW > maxSize) {\n      maxW = maxSize\n      maxH = Math.round(maxW / ratio)\n    }\n    if (maxH > maxSize) {\n      maxH = maxSize\n      maxW = Math.round(ratio * maxH)\n    }\n    if (image.width > maxW) {\n      var canvas = document.createElement('canvas')\n      canvas.width = maxW\n      canvas.height = maxH\n      canvas.getContext('2d').drawImage(image, 0, 0, maxW, maxH)\n      image.src = 'about:blank'\n      image.width = 1\n      image.height = 1\n      image = canvas\n    }\n\n    return image\n  }\n\n  /**\n   * Resize an image to the target `width` and `height`.\n   *\n   * Returns a Canvas with the resized image on it.\n   */\n  resizeImage (image, targetWidth, targetHeight) {\n    // Resizing in steps refactored to use a solution from\n    // https://blog.uploadcare.com/image-resize-in-browsers-is-broken-e38eed08df01\n\n    image = this.protect(image)\n\n    var steps = Math.ceil(Math.log2(image.width / targetWidth))\n    if (steps < 1) {\n      steps = 1\n    }\n    var sW = targetWidth * Math.pow(2, steps - 1)\n    var sH = targetHeight * Math.pow(2, steps - 1)\n    var x = 2\n\n    while (steps--) {\n      var canvas = document.createElement('canvas')\n      canvas.width = sW\n      canvas.height = sH\n      canvas.getContext('2d').drawImage(image, 0, 0, sW, sH)\n      image = canvas\n\n      sW = Math.round(sW / x)\n      sH = Math.round(sH / x)\n    }\n\n    return image\n  }\n\n  /**\n   * Save a <canvas> element's content to a Blob object.\n   *\n   * @param {HTMLCanvasElement} canvas\n   * @return {Promise}\n   */\n  canvasToBlob (canvas, type, quality) {\n    if (canvas.toBlob) {\n      return new Promise(resolve => {\n        canvas.toBlob(resolve, type, quality)\n      })\n    }\n    return Promise.resolve().then(() => {\n      return Utils.dataURItoBlob(canvas.toDataURL(type, quality), {})\n    })\n  }\n\n  getProportionalHeight (img, width) {\n    const aspect = img.width / img.height\n    return Math.round(width / aspect)\n  }\n\n  /**\n   * Set the preview URL for a file.\n   */\n  setPreviewURL (fileID, preview) {\n    const { files } = this.uppy.state\n    this.uppy.setState({\n      files: Object.assign({}, files, {\n        [fileID]: Object.assign({}, files[fileID], {\n          preview: preview\n        })\n      })\n    })\n  }\n\n  addToQueue (item) {\n    this.queue.push(item)\n    if (this.queueProcessing === false) {\n      this.processQueue()\n    }\n  }\n\n  processQueue () {\n    this.queueProcessing = true\n    if (this.queue.length > 0) {\n      const current = this.queue.shift()\n      return this.requestThumbnail(current)\n        .catch(err => {}) // eslint-disable-line handle-callback-err\n        .then(() => this.processQueue())\n    } else {\n      this.queueProcessing = false\n    }\n  }\n\n  requestThumbnail (file) {\n    if (Utils.isPreviewSupported(file.type) && !file.isRemote) {\n      return this.createThumbnail(file, this.opts.thumbnailWidth)\n        .then(preview => {\n          this.setPreviewURL(file.id, preview)\n        })\n        .catch(err => {\n          console.warn(err.stack || err.message)\n        })\n    }\n    return Promise.resolve()\n  }\n\n  install () {\n    this.uppy.on('file-added', this.addToQueue)\n  }\n  uninstall () {\n    this.uppy.off('file-added', this.addToQueue)\n  }\n}\n"]}